#!/bin/bash
# Run the proper commands for executing a constituent solver on a given COP.

SOLVER=$1
MZN=$2
DZN=$3
FZN=$4
OZN=$5
OUT=$6
TYPE=$7

OUTPUT_SCRIPT="$SUNNY_HOME/src/output_script"
SOLVERS_DIR="$SUNNY_HOME/solvers"

MZN2FZN_PARAM=""
SOLVER_EXE="flatzinc"
SOLVER_PARAM=""
MZNLIB=""
STDLIB=""

# No .dzn file is provided.
if 
  [ "$DZN" == 'NODATA' ]
then
  DZN=''
fi

if 
  [ "$TYPE" == 'COP' ]
then
  SOLVER_PARAM="-a $SOLVER_PARAM"
fi

# For each constituent solver execute the corresponding commands: first the .mzn 
# is converted to the specific .fzn, and then the .fzn is run. 

################################################################
# Parameters to run the solvers of the MiniZinc suite
################################################################
if
  [ $SOLVER == "g12cbc" ]
then
  MZN2FZN_PARAM="-G linear $MZN2FZN_PARAM"
  SOLVER_PARAM="-b mip $SOLVER_PARAM"
elif
  [ $SOLVER == "g12cpx" ]
then
  MZN2FZN_PARAM="-G g12_cpx $MZN2FZN_PARAM"
  SOLVER_EXE="fzn_cpx"
elif
  [ $SOLVER == "g12fd" ]
then
  MZN2FZN_PARAM="-G g12_fd $MZN2FZN_PARAM"
elif
  [ $SOLVER == "g12lazyfd" ]
then
  MZN2FZN_PARAM="-G g12_lazyfd $MZN2FZN_PARAM"
  SOLVER_PARAM="-b lazy $SOLVER_PARAM"
else 
################################################################
# Parameters to run other solvers of the MiniZinc suite
################################################################
  SOLVER_DIR=$SOLVERS_DIR/$SOLVER
  
  if [ ! -f "$SOLVER_DIR/fzn-exec" ]; then
    echo "The solver $SOLVER/fzn-exec was not found. Please verify its 
installation." >&2
    exit 1
  fi
    
  if [ -d "$SOLVER_DIR/mzn-lib" ]; then
    MZNLIB="-I $SOLVER_DIR/mzn-lib"
  fi
  
  if [ -d "$SOLVER_DIR/std-lib" ]; then
    STDLIB="-I $SOLVER_DIR/std-lib"
  fi
  
  SOLVER_EXE="$SOLVER_DIR/fzn-exec"
fi

################################################################
# MiniZinc conversion into FlatZinc
################################################################
mzn2fzn $MZNLIB $STDLIB $MZN $DZN -o $FZN --output-ozn-to-file $OZN > /dev/null 2> /dev/null
ret=$?
if 
  [ $ret -ne 0 ]
then
  echo "MiniZinc model not converted (return value $ret)" >&2
  exit $ret
else
################################################################
# Run FlatZinc solver
################################################################
  $SOLVER_EXE $SOLVER_PARAM $FZN 2> /dev/null | grep " = \|==========\|----------\|=====UNSAT\|=====UNBO"
  exit ${PIPESTATUS[0]}    
fi